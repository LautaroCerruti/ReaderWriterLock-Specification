\documentclass{article}
\usepackage{fuzz}
\begin{document}
\begin{zed}
[PROCESS] \\
\also
STATE ::= locked | unlocked\\
\also
RESPONSE ::= ok | errorCantBeLessThanOne | errorCantAllowMoreReaders \\ 
| errorCantBeLessThanActualReaders | errorLockedByWriter | errorLockedByReader \\
| errorReadNotAcquired | errorWriteNotLocked | errorWriteLockedByOtherProcess \\
| errorAlreadyAcquired  
\end{zed}

\begin{axdef}
creatorProcess : PROCESS
\end{axdef}

\begin{schema}{ReadersWriterLock}
    readers : \power PROCESS \\
    writerLockState : STATE \\
    writer: PROCESS \\
    maxReaders : \num
\end{schema}

\begin{schema}{ReadersWriterLockInit}
    ReadersWriterLock
\where
    readers = \emptyset \\
    writerLockState = unlocked \\
    writer = creatorProcess \\
    maxReaders = 1
\end{schema}

\begin{schema}{InvMaxReadersPositive}
    ReadersWriterLock
\where
    maxReaders > 0
\end{schema}

\begin{schema}{InvReadersLessThanMaxReaders}
    ReadersWriterLock
\where
    \#readers \leq maxReaders
\end{schema}

\begin{schema}{InvNoReadersWhileWriter}
    ReadersWriterLock
\where
    writerLockState = locked \implies readers = \emptyset
\end{schema}

\begin{schema}{SetMaxReadersOk}
    \Delta ReadersWriterLock \\
    n?: \num \\
    res!: RESPONSE
\where
    n? > 0 \\
    \#readers \leq n? \\
    maxReaders' = n? \\
    readers' = readers \\
    writerLockState' = writerLockState \\
    writer' = writer \\
    res! = ok
\end{schema}

\begin{schema}{MaxReadersIncorrectValue}
    \Xi ReadersWriterLock \\
    n?: \num \\
    res!: RESPONSE
\where
    n? \leq 0 \\
    res! = errorCantBeLessThanOne
\end{schema}

\begin{schema}{LessThanActualReaders}
    \Xi ReadersWriterLock \\
    n?: \num \\
    res!: RESPONSE
\where
    n? < \# readers \\
    res! = errorCantBeLessThanActualReaders
\end{schema}

\begin{zed}
SetMaxReadersErrors \defs MaxReadersIncorrectValue \lor LessThanActualReaders 
\also
SetMaxReaders \defs SetMaxReadersOk \lor SetMaxReadersErrors
\end{zed}

\begin{schema}{AcquireReadOk}
    \Delta ReadersWriterLock \\
    p?: PROCESS \\
    res!: RESPONSE
\where
    p? \notin readers \\
    writerLockState = unlocked \\
    \# readers < maxReaders \\
    readers' = readers \cup \{p?\} \\
    writerLockState' = writerLockState \\
    writer' = writer \\
    maxReaders' = maxReaders \\
    res! = ok
\end{schema}

\begin{schema}{AlreadyLockedRead}
    \Xi ReadersWriterLock \\
    p?: PROCESS \\
    res!: RESPONSE
\where
    p? \in readers \\
    res! = errorAlreadyAcquired
\end{schema}

\begin{schema}{MaxReadersReached}
    \Xi ReadersWriterLock \\
    res!: RESPONSE
\where
    \# readers = maxReaders \\
    res! = errorCantAllowMoreReaders
\end{schema}

\begin{schema}{ProcessIsWriting}
    \Xi ReadersWriterLock \\
    res!: RESPONSE
\where
    writerLockState = locked \\
    res! = errorLockedByWriter
\end{schema}

\begin{zed}
AcquireReadError \defs AlreadyLockedRead \lor ProcessIsWriting \lor MaxReadersReached  
\also
AcquireRead \defs AcquireReadOk \lor AcquireReadError 
\end{zed}

\begin{schema}{AcquireWriteOk}
    \Delta ReadersWriterLock \\
    p?: PROCESS \\
    res!: RESPONSE
\where
    writerLockState = unlocked \\
    readers = \emptyset \\
    writer' = p? \\
    writerLockState' = locked \\
    readers' = readers \\
    maxReaders' = maxReaders \\
    res! = ok
\end{schema}

\begin{schema}{AlreadyLockedWrite}
    \Xi ReadersWriterLock \\
    p?: PROCESS \\
    res!: RESPONSE
\where
    writerLockState = locked \\
    writer = p? \\
    res! = errorAlreadyAcquired
\end{schema}

\begin{schema}{WriteLockedByOtherProcess}
    \Xi ReadersWriterLock \\
    p?: PROCESS \\
    res!: RESPONSE
\where
    writerLockState = locked \\
    writer \neq p? \\
    res! = errorWriteLockedByOtherProcess
\end{schema}

\begin{schema}{ProcessIsReading}
    \Xi ReadersWriterLock \\
    res!: RESPONSE
\where
    readers \neq \emptyset \\
    res! = errorLockedByReader
\end{schema}

\begin{zed}
AcquireWriteError \defs AlreadyLockedWrite \lor WriteLockedByOtherProcess \\ \quad \lor ProcessIsReading 
\also
AcquireWrite \defs AcquireWriteOk \lor AcquireWriteError 
\end{zed}

\begin{schema}{ReleaseReadOk}
    \Delta ReadersWriterLock \\
    p?: PROCESS \\
    res!: RESPONSE
\where
    p? \in readers \\
    readers' = readers \setminus \{p?\} \\
    writerLockState' = writerLockState \\
    writer' = writer \\
    maxReaders' = maxReaders \\
    res! = ok
\end{schema}

\begin{schema}{ReadNotAcquired}
    \Xi ReadersWriterLock \\
    p?: PROCESS \\
    res!: RESPONSE
\where
    p? \notin readers \\
    res! = errorReadNotAcquired
\end{schema}

\begin{zed}
ReleaseRead \defs ReleaseReadOk \lor ReadNotAcquired
\end{zed}

\begin{schema}{ReleaseWriteOk}
    \Delta ReadersWriterLock \\
    p?: PROCESS \\
    res!: RESPONSE
\where
    writerLockState = locked \\
    writer = p? \\
    writerLockState' = unlocked \\
    readers' = readers \\
    writer' = writer \\
    maxReaders' = maxReaders \\
    res! = ok
\end{schema}

\begin{schema}{WriteNotLocked}
    \Xi ReadersWriterLock \\
    res!: RESPONSE
\where
    writerLockState = unlocked \\
    res! = errorWriteNotLocked
\end{schema}

\begin{zed}
ReleaseWriteError \defs WriteNotLocked \lor WriteLockedByOtherProcess 
\\
ReleaseWrite \defs ReleaseWriteOk \lor ReleaseWriteError
\end{zed}
\end{document}
